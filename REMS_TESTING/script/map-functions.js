// Enhanced Barangay coordinates for Tarlac City, Philippines
// Updated with more accurate coordinates centered on each barangay
const tarlacBarangayCoordinates = {
   	
    "AGUSO": [15.533878810654183, 120.60030870566762],
    "ALVINDIA": [15.547325685700969, 120.60699967810436],
    "AMUCAO": [15.471820249955861, 120.68698674288191],
    "ARMENIA": [15.429244387992833, 120.5446769718291],
    "ASTURIAS": [15.445027123438573, 120.66860645104418],
    "ATIOC": [15.448721604941232, 120.58399112070715],
    "BALANTI": [15.464024695321912, 120.55463033155351],
    "BALETE": [15.446651690604456, 120.62249813118724],
    "BALIBAGO 1ST": [15.53127637945293, 120.61700099803424],
    "BALIBAGO 2ND": [15.530851923744152, 120.63767824318802],
    "BALINGCANAWAY": [15.49247410171956, 120.68217816345685],
    "BANABA": [15.518023057803283, 120.62741202546324],
    "BANTOG": [15.46408266323762, 120.66098685980167],
    "BARAS-BARAS": [15.524362334888945, 120.56071917114404],
    "BATANG-BATANG": [15.52508364912649, 120.65692944708462],
    "BINAUGANAN": [15.473260057724417, 120.61014915267324],
    "BORA": [15.50255647985402, 120.63470810778075],
    "BUENAVISTA": [15.415788478133912, 120.6236192856281],
    "BUHILIT (BUJILIT)": [15.511322042484464, 120.61170010612916],
    "BUROT": [15.41575013637895, 120.5929351355006],
    "CALINGCUAN": [15.492754879975388, 120.62134606848159],
    "CAPEHAN": [15.426386199356205, 120.60971334937314],
    "CARANGIAN (CARANGINA)": [15.47920817022633, 120.57274991234222],
    "CARE": [15.490742851432948, 120.55645712503703],
    "CENTRAL": [15.429143421613695, 120.6332427710685],
    "CULIPAT": [15.50146190297379, 120.6156754849379],
    "CUT-CUT 1ST": [15.308906149586884, 120.56571822892712],
    "CUT-CUT 2ND": [15.312899390692444, 120.54205937103156],
    "DALAYAP": [15.538393695464979, 120.61230956807539],
    "DELA PAZ": [15.422497359033972, 120.57809589287363],
    "DOLORES": [15.526893098384841, 120.5754606271707],
    "LAOANG": [15.547723723379825, 120.54233248418744],
    "LIGTASAN": [15.497417697253224, 120.60347195962107],
    "LOURDES": [15.431668368255663, 120.65141167432644],
    "MABINI": [15.490526226147995, 120.58948665219262],
    "MALIGAYA": [15.44583264169799, 120.62148252714127],
    "MALIWALO": [15.48235352464786, 120.62863978419097],
    "MAPALACSIAO": [15.425579450349284, 120.6574493301855],
    "MAPALAD": [15.540039952553052, 120.55961737283602],
    "MATADERO": [15.501039469983647, 120.60476619741873],
    "MATATALAIB": [15.48978262094097, 120.6067108974593],
    "MOLAVE": [15.51317038077203, 120.57691081429593],
    "PARAISO": [15.45235788194406, 120.62998886763648],
    "POBLACION": [15.48912686245387, 120.59085062890155],
    "SALAPUNGAN": [15.507184222125714, 120.5948918935315],
    "SAN CARLOS": [15.413874438061379, 120.57214636756451],
    "SAN FRANCISCO": [15.44256407311695, 120.58972519971951],
    "SAN ISIDRO": [15.510268666589422, 120.5824087959671],
    "SAN JOSE": [15.48472090131634, 120.65260154536595],
    "SAN JUAN DE URQUICO": [15.454676988453889, 120.57102425620123],
    "SAN JUAN DE MATA": [15.534434267054653, 120.5305172439567],
    "SAN LUIS": [15.465064691108545, 120.57108053263215],
    "SAN MANUEL": [15.497617357792741, 120.64877316451549],
    "SAN MIGUEL": [15.441578145772567, 120.5882077663027],
    "SAN NICOLAS": [15.493999827671052, 120.59587068824027],
    "SAN PABLO": [15.473071522553186, 120.57814026534129],
    "SAN PASCUAL": [15.508580513629173, 120.6629654585257],
    "SAN RAFAEL": [15.457225550595872, 120.58703226798285],
    "SAN ROQUE": [15.48038717048588, 120.59338155550844],
    "SAN SEBASTIAN": [15.470080504479485, 120.59807888529079],
    "SAN VICENTE": [15.472822661657743, 120.5881894568437],
    "SANTA CRUZ": [15.550841969234071, 120.59408242435502],
    "SANTA MARIA": [15.55101161671691, 120.58098568891486],
    "SANTO CRISTO": [15.48880318030958, 120.59518212973309],
    "SANTO DOMINGO": [15.540980857395365, 120.51926227442983],
    "SANTO NINO": [15.553853495057554, 120.57124839508654],
    "SAPANG MARAGUL": [15.513119836375726, 120.54431926897195],
    "SAPANG TAGALOG": [15.417665648235477, 120.61110546255792],
    "SEPUNG CALZADA": [15.50398557641383, 120.59839359825419],
    "SINAIT": [15.536437730584806, 120.58257371409938],
   	"SUIZO": [15.459914137373394, 120.60554377949269],
 	"TARIJI": [15.520977288066511, 120.60686202148912],
    "TIBAG": [15.501958933367279, 120.56984075447136],
    "TIBAGAN": [15.47378571595816, 120.5478080848472],
    "TRINIDAD": [15.511890853451451, 120.63273374819563],
    "UNGOT": [15.458225192807905, 120.6169856620704],
    "VILLA BACOLOR": [15.50589823622022, 120.68032600272727],
    
};

// Map instance
let propertyMap = null;
let propertyMarker = null;
let currentProperty = null;

/**
 * Get coordinates for a barangay in Tarlac City
 * @param {string} barangay - Barangay name
 * @returns {Array} - [latitude, longitude]
 */
function getBarangayCoordinates(barangay) {
    if (!barangay) return [15.4751, 120.5969]; // Default to Tarlac City center
    
    // Normalize barangay name (uppercase, trim, remove extra spaces)
    const normalizedBarangay = barangay.toUpperCase().trim().replace(/\s+/g, ' ');
    
    // Direct match
    if (tarlacBarangayCoordinates[normalizedBarangay]) {
        console.log(`‚úì Found exact coordinates for ${normalizedBarangay}:`, tarlacBarangayCoordinates[normalizedBarangay]);
        return tarlacBarangayCoordinates[normalizedBarangay];
    }
    
    // Try to find partial match (e.g., "BALIBAGO" matches "BALIBAGO 1ST")
    const partialMatch = Object.keys(tarlacBarangayCoordinates).find(key => 
        key.includes(normalizedBarangay) || normalizedBarangay.includes(key)
    );
    
    if (partialMatch) {
        console.log(`‚úì Found partial match for ${normalizedBarangay}: ${partialMatch}`);
        return tarlacBarangayCoordinates[partialMatch];
    }
    
    // Default to Tarlac City center if not found
    console.log(`‚ö† No coordinates found for ${normalizedBarangay}, using city center`);
    return [15.4751, 120.5969];
}

/**
 * Initialize the property location map with draggable marker
 * @param {Object} property - Property object with location data
 */
function initializePropertyMap(property) {
    console.log('Initializing map for property:', property);
    
    // Store current property
    currentProperty = property;
    
    // Check if map container exists
    const mapContainer = document.getElementById('propertyMap');
    if (!mapContainer) {
        console.error('Map container not found');
        return;
    }
    
    // Get coordinates (use stored coordinates if available, otherwise use barangay)
    let coordinates;
    if (property.latitude && property.longitude) {
        coordinates = [parseFloat(property.latitude), parseFloat(property.longitude)];
        console.log(`Using stored coordinates [${coordinates[0]}, ${coordinates[1]}]`);
    } else {
        coordinates = getBarangayCoordinates(property.barangay);
        console.log(`Using barangay-based coordinates [${coordinates[0]}, ${coordinates[1]}] for ${property.barangay}`);
    }
    
    const [lat, lng] = coordinates;
    
    // Remove existing map if any
    if (propertyMap) {
        propertyMap.remove();
        propertyMap = null;
    }
    
    // Initialize the map with higher zoom for better detail
    propertyMap = L.map('propertyMap').setView([lat, lng], 16);
    
    // Add multiple tile layer options for better detail
    // Option 1: OpenStreetMap (default - free, good detail)
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 10
    }).addTo(propertyMap);
    
    // Option 2: OpenStreetMap HOT (Humanitarian) - More detailed for some areas
    const hotLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by HOT',
        maxZoom: 19,
        minZoom: 10
    });
    
    // Option 3: Esri World Imagery (Satellite view)
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri',
        maxZoom: 18,
        minZoom: 10
    });
    
    // Add layer control to switch between map types
    const baseLayers = {
        "Street Map": osmLayer,
        "Detailed Map": hotLayer,
        "Satellite": satelliteLayer
    };
    
    L.control.layers(baseLayers).addTo(propertyMap);
    
    // Create custom draggable icon
    const customIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    // Add draggable marker
    const fullAddress = `${property.street || ''}, ${property.barangay || ''}, ${property.city || 'Tarlac City'}, ${property.province || 'Tarlac'}`;
    const formattedPrice = property.price ? '‚Ç±' + parseFloat(property.price).toLocaleString() : 'N/A';
    
    propertyMarker = L.marker([lat, lng], { 
        icon: customIcon, 
        draggable: true,  // Make marker draggable
        autoPan: true
    }).addTo(propertyMap);
    
    // Create popup content
    const popupContent = `
        <div class="map-popup-title">${property.owner_name || 'Property'}</div>
        <div class="map-popup-address">${fullAddress}</div>
        <div class="map-popup-price">${formattedPrice}</div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
            <i class="fas fa-arrows-alt"></i> Drag marker to adjust location
        </div>
    `;
    
    propertyMarker.bindPopup(popupContent).openPopup();
    
    // Handle marker drag events
    propertyMarker.on('dragstart', function(e) {
        console.log('Marker drag started');
        propertyMarker.closePopup();
    });
    
    propertyMarker.on('dragend', function(e) {
        const newPosition = e.target.getLatLng();
        console.log('Marker dragged to new position:', newPosition);
        
        // Update popup with new coordinates
        const updatedPopup = `
            <div class="map-popup-title">${property.owner_name || 'Property'}</div>
            <div class="map-popup-address">${fullAddress}</div>
            <div class="map-popup-price">${formattedPrice}</div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 11px; color: #666;">
                <strong>New Location:</strong><br>
                Lat: ${newPosition.lat.toFixed(6)}<br>
                Lng: ${newPosition.lng.toFixed(6)}
            </div>
            <button onclick="saveMarkerPosition(${newPosition.lat}, ${newPosition.lng}, ${property.id})" 
                    style="margin-top: 8px; padding: 6px 12px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                <i class="fas fa-save"></i> Save New Location
            </button>
        `;
        
        propertyMarker.bindPopup(updatedPopup).openPopup();
        
        // Center map on new position
        propertyMap.panTo(newPosition);
    });
    
    // Add scale control
    L.control.scale({
        imperial: false,
        metric: true
    }).addTo(propertyMap);
    
    // Add current location button (optional)
    const locationControl = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function(map) {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = '<a href="#" title="Center on marker" style="font-size: 18px; line-height: 26px; width: 26px; height: 26px; display: block; text-align: center; text-decoration: none; color: black;">üìç</a>';
            
            container.onclick = function(e) {
                e.preventDefault();
                if (propertyMarker) {
                    propertyMap.setView(propertyMarker.getLatLng(), 17);
                    propertyMarker.openPopup();
                }
            };
            
            return container;
        }
    });
    
    propertyMap.addControl(new locationControl());
    
    // Invalidate size to ensure proper rendering
    setTimeout(() => {
        if (propertyMap) {
            propertyMap.invalidateSize();
        }
    }, 100);
}

/**
 * Save marker position to database
 * @param {number} lat - Latitude
 * @param {number} lng - Longitude
 * @param {number} propertyId - Property ID
 */
function saveMarkerPosition(lat, lng, propertyId) {
    console.log(`Saving new position [${lat}, ${lng}] for property ${propertyId}`);
    
    // Show loading state
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    // Send update to server
    fetch('api.php?endpoint=update_property_location', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            property_id: propertyId,
            latitude: lat,
            longitude: lng
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úì Location saved successfully');
            
            // Update button to show success
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            saveBtn.style.background = '#4CAF50';
            
            // Update property object if accessible
            if (currentProperty) {
                currentProperty.latitude = lat;
                currentProperty.longitude = lng;
            }
            
            // Close popup after 2 seconds
            setTimeout(() => {
                if (propertyMarker) {
                    propertyMarker.closePopup();
                }
            }, 2000);
            
        } else {
            console.error('‚úó Failed to save location:', data.message);
            alert('Failed to save location: ' + data.message);
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('‚úó Error saving location:', error);
        alert('An error occurred while saving the location. Please try again.');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// Export functions for use in main management.js
if (typeof window !== 'undefined') {
    window.getBarangayCoordinates = getBarangayCoordinates;
    window.initializePropertyMap = initializePropertyMap;
    window.saveMarkerPosition = saveMarkerPosition;
}